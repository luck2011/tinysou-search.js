!function(a){function b(a){return String(a).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function c(a){this.size=0,this.limit=a,this._keymap={}}var d=function(a){var b,c,d={};if(""===a)return{};for(b=0;b<a.length;b+=1)c=a[b].split("="),2===c.length&&(d[c[0]]=decodeURIComponent(c[1].replace(/\+/g," ")));return d};a.queryParams=function(){return d(window.location.search.substr(1).split("&"))},a.hashParams=function(){return d(window.location.hash.substr(1).split("&"))};var e=0;window.TinySou=window.TinySou||{},TinySou.root_url=TinySou.root_url||"http://api.tinysou.com",TinySou.pingUrl=function(a,b){var c=setTimeout(b,350),d=new Image;return d.onload=d.onerror=function(){clearTimeout(c),b()},d.src=a,!1},TinySou.pingSearchResultClick=function(b,c,d){var e={t:(new Date).getTime(),engine_key:b,doc_id:c,q:TinySou.currentQuery},f=TinySou.root_url+"/v1/public/analytics/pc?"+a.param(e);TinySou.pingUrl(f,d)},TinySou.pingAutoSelection=function(b,c,d,e){var f={t:(new Date).getTime(),engine_key:b,doc_id:c,prefix:d},g=TinySou.root_url+"/v1/public/analytics/pas?"+a.param(f);TinySou.pingUrl(g,e)},TinySou.findSelectedSection=function(){function b(a){var b=a.replace(/\s+/g,"");return b=b.toLowerCase()}var c=a.hashParams().sts;c&&(c=b(c),a("h1, h2, h3, h4, h5, h6").each(function(){return $this=a(this),b($this.text()).indexOf(c)>=0?(this.scrollIntoView(!0),!1):void 0}))},TinySou.htmlEscape=TinySou.htmlEscape||function(a){return String(a).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},a.fn.tinysouSearch=function(b){var b=a.extend({},a.fn.tinysouSearch.defaults,b);return this.each(function(){var d=a(this),f=a.meta?a.extend({},b,d.data()):b;d.data("tinysou-config-search",f),d.selectedCallback=function(b){return function(c){var d=a(this);c.preventDefault(),TinySou.pingSearchResultClick(f.engineKey,b.document.id,function(){window.location=d.attr("href")})}},d.selectedActCallback=function(a){return function(){var b=d.val(),c=function(){f.onComplete(a,b)};TinySou.pingAutoSelection(f.engineKey,a.document.id,b,c)}},d.registerResult=function(b,c){b.data("tinysou-item",c),a("a",b).click(d.selectedCallback(c))},d.registerActResult=function(a,b){a.data("tinysou-item",b),a.click(d.selectedActCallback(b)).mouseover(function(){d.listResults().removeClass(f.activeItemClass),a.addClass(f.activeItemClass)})},d.abortCurrent=function(){d.currentRequest&&d.currentRequest.abort()},d.showList=function(){t(f.disableAutocomplete)===!1&&u.show()},d.hideList=function(a){a?u.hide():setTimeout(function(){u.hide()},10)},d.focused=function(){return d.is(":focus")},d.submitting=function(){d.submitted=!0},d.listResults=function(){return a(f.resultListSelector,v)},d.activeResult=function(){return d.listResults().filter("."+f.activeItemClass).first()},d.prevResult=function(){var a=d.listResults(),b=a.index(d.activeResult()),c=b-1,e=a.eq(c);d.listResults().removeClass(f.activeItemClass),c>=0&&e.addClass(f.activeItemClass)},d.nextResult=function(){var a=d.listResults(),b=a.index(d.activeResult()),c=b+1,e=a.eq(c);d.listResults().removeClass(f.activeItemClass),c>=0&&e.addClass(f.activeItemClass)},d.styleDropdown=function(){u.css(f.dropdownStylesFunction(d))},a(window).resize(function(){d.styleDropdown()}),d.isEmpty=function(b){return a.inArray(g(b),this.emptyQueries)>=0},d.addEmpty=function(a){d.emptyQueries.unshift(g(a))},d.getContentCache=function(){return a("#"+l)};var h;if("inline"==f.renderStyle)h=a(f.resultContainingElement);else if("new_page"==f.renderStyle){h=a(f.resultContainingElement);var i=window.location.toString().split("#")[0];i==f.resultPageURL&&(f.renderStyle="inline")}else a("body").append("<div id='ts-results-container' style='display: none;'></div>"),h=a("#ts-results-container");var k=h.html(),l="ts-content-cache",m=d.getContentCache(),n=function(a,b){location.hash="tsq="+encodeURIComponent(a)+"&tsp="+b},o=function(b,c){function d(a){if(void 0!==a){var b=a;return"function"==typeof b&&(b=b.call()),b}return void 0}c=a.extend({page:0},c);var e={};m.length||(h.after("<div id='"+l+"' style='display: none;'></div>"),m.html(k).hide()),f.loadingFunction(b,h),TinySou.currentQuery=b,e.q=b,e.engine_key=f.engineKey,e.page=c.page,e.per_page=f.perPage,e.search_fields=d(f.searchFields),e.fetch_fields=d(f.fetchFields),e.facets=d(f.facets),e.filters=d(f.filters),e.c=d(f.collection),e.functional_boosts=d(f.functionalBoosts),e.sort=d(f.sort),e.spelling=d(f.spelling),a.getJSON(TinySou.root_url+"/v1/public/search?callback=?",e).success(q)};a(window).hashchange(function(){var b=a.hashParams();if(b.tsq)o(b.tsq,{page:b.tsp});else{var c=d.getContentCache();c.length&&(h.html(c.html()),c.remove())}});var p=d.parents("form");p&&p.bind("submit",function(a){a.preventDefault();var b=d.val();n(b,0)}),a(document).on("click","[data-hash][data-page]",function(b){b.preventDefault();var c=a(this);n(a.hashParams().tsq,c.data("page"))}),a(document).on("click","[data-hash][data-spelling-suggestion]",function(b){b.preventDefault();var c=a(this);n(c.data("spelling-suggestion"),1)});var q=function(a){"function"==typeof f.preRenderFunction&&f.preRenderFunction.call(d,a),f.renderResultsFunction(d.getContext(),a),"function"==typeof f.postRenderFunction&&f.postRenderFunction.call(d,a)};d.getContext=function(){return{config:f,resultContainer:h,registerResult:d.registerResult}},d.getActContext=function(){return{config:f,list:v,registerActResult:d.registerActResult}},d.attr("autocomplete","off"),d.data("tinysou-config-autocomplete",f),d.submitted=!1,d.cache=new c(10),d.emptyQueries=[];var r=f.dropdownStylesFunction(d),s=a('<div class="tinysou-widget" />'),u=a("<div />").addClass(f.suggestionListClass).appendTo(s).css(r).hide();s.appendTo(f.autocompleteContainingElement);var v=a("<"+f.suggestionListType+" />").appendTo(u);d.data("tinysou-list",v);var w,x=!1;d.lastValue="",d.keyup(function(a){return x?void(x=!1):void(a.which>36&&a.which<41||16==a.which||(f.typingDelay>0?(clearTimeout(w),w=setTimeout(function(){j(d)},f.typingDelay)):j(d)))}),d.keydown(function(a){d.styleDropdown();var b=d.activeResult();switch(a.which){case 13:0!==b.length&&v.is(":visible")?(a.preventDefault(),d.selectedActCallback(b.data("tinysou-item"))()):d.currentRequest&&d.submitting(),d.hideList(),x=!0;break;case 38:a.preventDefault(),0===b.length?d.listResults().last().addClass(f.activeItemClass):d.prevResult();break;case 40:a.preventDefault(),0===b.length?d.listResults().first().addClass(f.activeItemClass):b!=d.listResults().last()&&d.nextResult();break;case 27:d.hideList(),x=!0;break;default:d.submitted=!1}}),d.keypress(function(a){13==a.which&&d.activeResult().length>0&&a.preventDefault()});var y=!1,z=!1;a(document).bind("mousedown.tinysou"+ ++e,function(){y=!0}),a(document).bind("mouseup.tinysou"+e,function(){y=!1,z&&(z=!1,d.hideList())}),d.blur(function(){y?z=!0:d.hideList()}),d.focus(function(){setTimeout(function(){d.select()},10),d.listResults().filter(":not(."+f.noResultsClass+")").length>0&&d.showList()}),a(window).hashchange()})};var f=function(b,c){var d,e,f,g,h='<div class="ts-page">';f=c.page,g=c.total,1!=f&&(d=f-1,h=h+'<a href="#" class="ts-prev" data-hash="true" data-page="'+d+'">&laquo; previous</a>'),g>f&&(e=f+1,h=h+'<a href="#" class="ts-next" data-hash="true" data-page="'+e+'">next &raquo;</a>'),h+="</div>",a(h).appendTo(b.resultContainer)},g=function(b){return a.trim(b).toLowerCase()},h=function(b,c){b.abortCurrent();var d={},e=b.data("tinysou-config-autocomplete");d.q=c,d.engine_key=e.engineKey,d.search_fields=t(e.searchFields),d.fetch_fields=t(e.fetchFields),d.filters=t(e.filters),d.c=t(e.collection),d.functional_boosts=t(e.functionalBoosts),d.sort=t(e.sort),d.per_page=e.resultLimit;var f=TinySou.root_url+"/v1/public/autocomplete";b.currentRequest=a.ajax({type:"GET",dataType:"jsonp",url:f,data:d}).success(function(a){var d=g(c);return a.info.total>0?(b.cache.put(d,a.records),void k(b,a.records,c)):(b.addEmpty(d),b.data("tinysou-list").empty(),void b.hideList())})},i=function(a,b){var c=g(b);if(a.isEmpty(c))return a.data("tinysou-list").empty(),void a.hideList();var d=a.cache.get(c);d?k(a,d,b):h(a,b)},j=function(b){var c=b.val();if(c!==b.lastValue)return b.lastValue=c,""===a.trim(c)?(b.data("tinysou-list").empty(),void b.hideList()):void("undefined"!=typeof b.data("tinysou-config-autocomplete").engineKey&&i(b,c))},k=function(a,b){var c=a.data("tinysou-list"),d=a.data("tinysou-config-autocomplete");c.empty(),a.hideList(!0),d.renderActResultsFunction(a.getActContext(),b);var e=a.listResults().length;(e>0&&a.focused()||void 0!==d.noResultsMessage)&&(a.submitted?a.submitted=!1:a.showList())},l=function(b,c){var d=b.resultContainer,e=b.config;if(d.html(""),a.each(c.records,function(c,f){b.registerResult(a(e.renderFunction(f)).appendTo(d),f)}),f(b,c.info),e.renderStyle){if("new_page"==e.renderStyle){var g=e.resultPageURL+window.location.hash;window.location.replace(g),e.renderStyle="inline",e.resultContainingElement="#ts-results-container"}}else a("#ts-results-container").appendTo("body").modal()},m=function(a){return'<div class="ts-result"><h3 class="title"><a href="'+a.document.url+'" class="ts-search-result-link">'+b(a.document.title)+"</a></h3></div>"},n=function(a,b){b.html('<p class="ts-loading-message">loading...</p>')},o=function(a){var b=a.info,c=0,d=0,e=this.getContext().resultContainer,f=null;b&&(c=b.total,d=b.max_score,b.spelling_suggestion&&(f=b.spelling_suggestion.text)),0===c&&e.html("<div id='ts-no-results' class='ts-no-results'>没有找到结果.</div>"),null!==f&&e.append('<div class="ts-spelling-suggestion">你是不是在找 <a href="#" data-hash="true" data-spelling-suggestion="'+f+'">'+f+"</a>?</div>")},p=function(b,c){var d=b.list,e=b.config;a.each(c,function(c,f){b.registerActResult(a("<li>"+e.renderActFunction(f)+"</li>").appendTo(d),f)})},q=function(a){return'<p class="title">'+TinySou.htmlEscape(a.document.title)+"</p>"},r=function(a){window.location=a.document.url},s=function(b){var c=b.data("tinysou-config-autocomplete"),d=c.attachTo?a(c.attachTo):b,e=d.offset(),f={position:"absolute","z-index":9999,top:e.top+d.outerHeight()+1,left:e.left};return c.setWidth&&(f.width=d.outerWidth()-2),f},t=function(a){if(void 0!==a){var b=a;return"function"==typeof b&&(b=b.call()),b}return void 0};c.prototype.put=function(a,b){var c={key:a,value:b};return this._keymap[a]=c,this.tail?(this.tail.newer=c,c.older=this.tail):this.head=c,this.tail=c,this.size===this.limit?this.shift():void this.size++},c.prototype.shift=function(){var a=this.head;return a&&(this.head.newer?(this.head=this.head.newer,this.head.older=void 0):this.head=void 0,a.newer=a.older=void 0,delete this._keymap[a.key]),a},c.prototype.get=function(a,b){var c=this._keymap[a];if(void 0!==c)return c===this.tail?c.value:(c.newer&&(c===this.head&&(this.head=c.newer),c.newer.older=c.older),c.older&&(c.older.newer=c.newer),c.newer=void 0,c.older=this.tail,this.tail&&(this.tail.newer=c),this.tail=c,b?c:c.value)},c.prototype.remove=function(a){var b=this._keymap[a];if(b)return delete this._keymap[b.key],b.newer&&b.older?(b.older.newer=b.newer,b.newer.older=b.older):b.newer?(b.newer.older=void 0,this.head=b.newer):b.older?(b.older.newer=void 0,this.tail=b.older):this.head=this.tail=void 0,this.size--,b.value},c.prototype.clear=function(){this.head=this.tail=void 0,this.size=0,this._keymap={}},c.prototype.keys="function"==typeof Object.keys?function(){return Object.keys(this._keymap)}:function(){var a=[];for(var b in this._keymap)a.push(b);return a},a.fn.tinysouSearch.defaults={attachTo:void 0,collection:"page",engineKey:void 0,searchFields:void 0,functionalBoosts:void 0,sort:void 0,fetchFields:["title","url"],renderStyle:void 0,resultPageURL:void 0,resultContainingElement:void 0,preRenderFunction:void 0,postRenderFunction:o,loadingFunction:n,renderResultsFunction:l,renderFunction:m,perPage:10,spelling:"strict",activeItemClass:"active",noResultsClass:"noResults",noResultsMessage:void 0,onComplete:r,renderActResultsFunction:p,renderActFunction:q,dropdownStylesFunction:s,resultLimit:void 0,suggestionListType:"ul",suggestionListClass:"autocomplete",resultListSelector:"li",setWidth:!0,typingDelay:80,disableAutocomplete:!1,autocompleteContainingElement:"body"}}(jQuery);